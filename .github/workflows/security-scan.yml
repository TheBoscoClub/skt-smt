# Comprehensive security scanning workflow
# Runs multiple security tools to detect vulnerabilities

name: "Security Scanning"

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit

    - name: Check dependencies with Safety
      run: |
        pip install -r requirements.txt
        safety check --json || true

    - name: Audit dependencies with pip-audit
      run: |
        pip-audit --desc --format json || true

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  bandit-scan:
    name: Bandit Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: Run Bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt || true

    - name: Upload Bandit results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-results
        path: bandit-report.json
        retention-days: 30

  semgrep-scan:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Semgrep
      run: |
        semgrep scan --config=auto --json --output=semgrep-report.json || true
        semgrep scan --config=auto || true

    - name: Upload Semgrep results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: semgrep-results
        path: semgrep-report.json
        retention-days: 30

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install pip-licenses
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses

    - name: Check licenses
      run: |
        pip install -r requirements.txt
        pip-licenses --format=markdown --with-urls > licenses.md
        pip-licenses --format=json > licenses.json
        cat licenses.md

    - name: Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-report
        path: |
          licenses.md
          licenses.json
        retention-days: 30

  sast-analysis:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install analysis tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 flake8-bandit flake8-bugbear pylint mypy

    - name: Run Flake8 with security plugins
      run: |
        flake8 . --count --select=E9,F63,F7,F82,S --show-source --statistics || true
        flake8 . --count --max-complexity=15 --max-line-length=127 --statistics || true

    - name: Run Pylint
      run: |
        pip install -r requirements.txt || true
        pylint **/*.py --exit-zero --output-format=json > pylint-report.json || true
        pylint **/*.py --exit-zero || true

    - name: Upload SAST results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: sast-results
        path: pylint-report.json
        retention-days: 30

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-check, secret-scan, bandit-scan, semgrep-scan, license-check, sast-analysis]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate summary
      run: |
        echo "# Security Scan Summary" > security-summary.md
        echo "" >> security-summary.md
        echo "**Scan Date:** $(date)" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Scans Completed" >> security-summary.md
        echo "- Dependency Security Check" >> security-summary.md
        echo "- Secret Scanning" >> security-summary.md
        echo "- Bandit Security Scan" >> security-summary.md
        echo "- Semgrep Security Scan" >> security-summary.md
        echo "- License Compliance Check" >> security-summary.md
        echo "- SAST Analysis" >> security-summary.md
        cat security-summary.md

    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md
        retention-days: 90
